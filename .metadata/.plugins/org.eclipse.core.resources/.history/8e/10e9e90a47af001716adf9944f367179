import java.time.LocalTime;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;


import org.apache.poi.xssf.usermodel.*;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.ss.util.CellRangeAddress;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;

import java.util.Map;
import java.util.HashMap;
import java.io.FileOutputStream;


public class Pacechart {
	double distance;
	double[] elevation;
	double[] manualWeighting;
	private LocalTime averagePace;
	ArrayList<Split> raceSplits;
	
	public void createPaceChart(Workbook wb, LocalTime plannedRaceTime, LocalTime startDelay, double fade) {
		
		
        String chartName = plannedRaceTime.getHour() + "h" + plannedRaceTime.getMinute() + " " + (int)fade;
		Sheet sheet = wb.createSheet(chartName);

		// calculate the average pace from the planned race time and the start delay
		double totalWeightedTimeDec = 0;
		double timeOverrunFactor;
		double finalElapsedTimeDec = 0;
		
		raceSplits = new ArrayList<Split>();
		
		System.out.println("Planned time: " + plannedRaceTime);
		System.out.println("Start Delay: " + startDelay);
		System.out.println("Moving Time:" + utils.DoubleToTime(utils.TimeToDouble(plannedRaceTime) - utils.TimeToDouble(startDelay)));
		averagePace = utils.DoubleToTime((utils.TimeToDouble(plannedRaceTime) - utils.TimeToDouble(startDelay)) / distance);
		System.out.println("Average Moving Pace: " + averagePace);
		
		// calculate what we can without totals
		for (int counter = 1;counter < Math.ceil(distance) + 1; counter ++)  //TODO: cater for fractions eg 21.1
		{
			Split raceSplit = new Split();
			
	        // the last lap may be a different (shorter) distance
			raceSplit.splitNumber = counter;
	        if (counter == Math.ceil(distance))
	        	raceSplit.distance = ((double)Math.round((distance - Math.floor(distance))*100))/100;
	        else
	        	raceSplit.distance = 1;
	        
	        raceSplit.elevation = elevation[counter];
	        raceSplit.manualWeighting = manualWeighting[counter];
	        
			// calculate the split time
	        if (counter == 1)
			{
				raceSplit.nominalTime = utils.DoubleToTime((utils.TimeToDouble(averagePace) + utils.TimeToDouble(startDelay)) * raceSplit.distance);
			}
			else
				raceSplit.nominalTime = utils.DoubleToTime(utils.TimeToDouble(averagePace) * raceSplit.distance);

			// cater for the fade 
	        if (counter <= 1+ distance/2)
	        	raceSplit.fadeFactor = 1 - fade/100;
	        else
	        	raceSplit.fadeFactor = 1 + fade/100;
	        	        
	        raceSplit.calculatePacePerSplit();
	        totalWeightedTimeDec += raceSplit.weightedTimeDec;
	        //System.out.println(counter + " " + raceSplit.nominalTime + " " + raceSplit.fadeFactor + " "  + utils.DoubleToTime(raceSplit.weightedTimeDec));
	        raceSplits.add((raceSplit));	         
		}
		// calculate totals how much out our total weighted time is
		timeOverrunFactor = totalWeightedTimeDec / utils.TimeToDouble(plannedRaceTime);

		// calculate final times
		for (Split raceSplit : raceSplits)
		{
			raceSplit.finalTimeDec = raceSplit.weightedTimeDec / timeOverrunFactor;
			raceSplit.finalTime = utils.DoubleToTime(raceSplit.finalTimeDec);
			raceSplit.finalPace = utils.DoubleToTime(raceSplit.finalTimeDec / raceSplit.distance); 
			finalElapsedTimeDec += raceSplit.finalTimeDec;
			raceSplit.finalElapsedTime = utils.DoubleToTime(finalElapsedTimeDec);
			System.out.println(raceSplit.splitNumber + "|" + utils.formatTime(raceSplit.finalTime) + "|" + utils.formatTime(raceSplit.finalElapsedTime) + "|" + utils.formatTime(raceSplit.finalPace) + "|" + (int) raceSplit.elevation);
			
		}
		
		//create spreadsheet
		Map<String, CellStyle> styles = createStyles(wb);
		int rowOffset = 0;
		Row row;
		Cell cell;
		rowOffset ++;

		row = sheet.createRow(rowOffset);		
		cell = CreateCell(styles,row,"styleTitle",0,"Time:");
		cell = CreateCell(styles,row,"styleSub",1,utils.formatTime(plannedRaceTime));
		rowOffset ++;

		row = sheet.createRow(rowOffset);		
		cell = CreateCell(styles,row,"styleTitle",0,"Start Delay");
		cell = CreateCell(styles,row,"styleSub",1,utils.formatTime(startDelay));
		rowOffset ++;

		row = sheet.createRow(rowOffset);		
		cell = CreateCell(styles,row,"styleTitle",0,"Fade");
		cell = CreateCell(styles,row,"styleSub",1,fade + "%");
		rowOffset ++;
		
		
		row = sheet.createRow(rowOffset);
		cell = row.createCell(0);
		cell = CreateCell(styles,row,"styleTitle",0,"Km");
		cell = CreateCell(styles,row,"styleTitle",1,"Elevation");
		cell = CreateCell(styles,row,"styleTitle",2,"Pace");
		cell = CreateCell(styles,row,"styleTitle",3,"Split");
		cell = CreateCell(styles,row,"styleTitle",4,"Total");

		rowOffset ++;
		rowOffset ++;
		
		for (Split raceSplit : raceSplits)
		{	
			row = sheet.createRow(rowOffset);
			cell = CreateCell(styles,row,"styleTitle",0,String.valueOf(raceSplit.splitNumber));
			cell = CreateCell(styles,row,"styleClean",1,String.valueOf(raceSplit.elevation));
			cell = CreateCell(styles,row,"styleClean",2,utils.formatTime(raceSplit.finalTime));
			cell = CreateCell(styles,row,"styleClean",3,utils.formatTime(raceSplit.finalPace));
			cell = CreateCell(styles,row,"styleClean",4,utils.formatTime(raceSplit.finalElapsedTime));
			rowOffset ++;
		}
	}
	
	private Cell CreateCell(Map<String, CellStyle> styles, Row row, String cellStyle,int col, String value) {
		Cell cell = row.createCell(col);
		cell.setCellStyle(styles.get(cellStyle));
		cell.setCellValue(value);
		return cell;
	}
	
	private static Map<String, CellStyle> createStyles(Workbook wb){
		String defaultFont = "Calibri";
        Map<String, CellStyle> styles = new HashMap<>();
        
        // setup the font
        Font font = wb.createFont();
        font.setFontHeightInPoints((short)12);
        font.setFontName(defaultFont);
        
        CellStyle style;
        
        style = wb.createCellStyle();
        style.setFont(font);
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        style.setBottomBorderColor(IndexedColors.BLACK.getIndex());
        style.setTopBorderColor(IndexedColors.BLACK.getIndex());
        style.setLeftBorderColor(IndexedColors.BLACK.getIndex());
        style.setRightBorderColor(IndexedColors.BLACK.getIndex());        
        style.setFillForegroundColor(IndexedColors.TAN.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        style.setAlignment(HorizontalAlignment.CENTER);
        styles.put("styleTitle", style);

        style = wb.createCellStyle();
        style.setFont(font);
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        style.setBottomBorderColor(IndexedColors.BLACK.getIndex());
        style.setTopBorderColor(IndexedColors.BLACK.getIndex());
        style.setLeftBorderColor(IndexedColors.BLACK.getIndex());
        style.setRightBorderColor(IndexedColors.BLACK.getIndex());        
        style.setFillForegroundColor(IndexedColors.AQUA.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        styles.put("styleSub", style);
        
        
        style = wb.createCellStyle();
        style.setFont(font);
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        style.setBottomBorderColor(IndexedColors.BLACK.getIndex());
        style.setTopBorderColor(IndexedColors.BLACK.getIndex());
        style.setLeftBorderColor(IndexedColors.BLACK.getIndex());
        style.setRightBorderColor(IndexedColors.BLACK.getIndex());
        style.setAlignment(HorizontalAlignment.RIGHT);
        styles.put("styleClean", style);
        
        
        
        
        Font itemFont = wb.createFont();
        itemFont.setFontHeightInPoints((short)9);
        itemFont.setFontName("Trebuchet MS");
        style = wb.createCellStyle();
        style.setAlignment(HorizontalAlignment.LEFT);
        style.setFont(itemFont);
        styles.put("item_left", style);

        style = wb.createCellStyle();
        style.setAlignment(HorizontalAlignment.RIGHT);
        style.setFont(itemFont);
        styles.put("item_right", style);

        style = wb.createCellStyle();
        style.setAlignment(HorizontalAlignment.RIGHT);
        style.setFont(itemFont);
        style.setBorderRight(BorderStyle.DOTTED);
        style.setRightBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderBottom(BorderStyle.DOTTED);
        style.setBottomBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderLeft(BorderStyle.DOTTED);
        style.setLeftBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderTop(BorderStyle.DOTTED);
        style.setTopBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setDataFormat(wb.createDataFormat().getFormat("_($* #,##0.00_);_($* (#,##0.00);_($* \"-\"??_);_(@_)"));
        styles.put("input_$", style);

        style = wb.createCellStyle();
        style.setAlignment(HorizontalAlignment.RIGHT);
        style.setFont(itemFont);
        style.setBorderRight(BorderStyle.DOTTED);
        style.setRightBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderBottom(BorderStyle.DOTTED);
        style.setBottomBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderLeft(BorderStyle.DOTTED);
        style.setLeftBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderTop(BorderStyle.DOTTED);
        style.setTopBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setDataFormat(wb.createDataFormat().getFormat("0.000%"));
        styles.put("input_%", style);

        style = wb.createCellStyle();
        style.setAlignment(HorizontalAlignment.RIGHT);
        style.setFont(itemFont);
        style.setBorderRight(BorderStyle.DOTTED);
        style.setRightBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderBottom(BorderStyle.DOTTED);
        style.setBottomBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderLeft(BorderStyle.DOTTED);
        style.setLeftBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderTop(BorderStyle.DOTTED);
        style.setTopBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setDataFormat(wb.createDataFormat().getFormat("0"));
        styles.put("input_i", style);

        style = wb.createCellStyle();
        style.setAlignment(HorizontalAlignment.CENTER);
        style.setFont(itemFont);
        style.setDataFormat(wb.createDataFormat().getFormat("m/d/yy"));
        styles.put("input_d", style);

        style = wb.createCellStyle();
        style.setAlignment(HorizontalAlignment.RIGHT);
        style.setFont(itemFont);
        style.setBorderRight(BorderStyle.DOTTED);
        style.setRightBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderBottom(BorderStyle.DOTTED);
        style.setBottomBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderLeft(BorderStyle.DOTTED);
        style.setLeftBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderTop(BorderStyle.DOTTED);
        style.setTopBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setDataFormat(wb.createDataFormat().getFormat("$##,##0.00"));
        style.setBorderBottom(BorderStyle.DOTTED);
        style.setBottomBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        styles.put("formula_$", style);

        style = wb.createCellStyle();
        style.setAlignment(HorizontalAlignment.RIGHT);
        style.setFont(itemFont);
        style.setBorderRight(BorderStyle.DOTTED);
        style.setRightBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderBottom(BorderStyle.DOTTED);
        style.setBottomBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderLeft(BorderStyle.DOTTED);
        style.setLeftBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setBorderTop(BorderStyle.DOTTED);
        style.setTopBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setDataFormat(wb.createDataFormat().getFormat("0"));
        style.setBorderBottom(BorderStyle.DOTTED);
        style.setBottomBorderColor(IndexedColors.GREY_40_PERCENT.getIndex());
        style.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        styles.put("formula_i", style);

        return styles;
    }

	
}
